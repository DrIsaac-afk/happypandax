
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>happypanda.core.commands.io_cmd &#8212; HappyPanda X 0.0.13#124 documentation</title>
    <link rel="stylesheet" href="../../../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/style.css" type="text/css" />
    <script type="text/javascript" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://platform.twitter.com/widgets.js"></script>
    <script type="text/javascript" src="../../../../_static/script.js"></script>
    <script type="text/javascript" src="../../../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../../../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../../../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../../index.html">
          HappyPanda X</a>
        <span class="navbar-text navbar-version pull-left"><b>0.0.13#124</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../../index.html">Contents <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../install.html">Installing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../usage.html">Using HappyPanda X</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../usage.html#securing-happypanda-x">Securing HappyPanda X</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../usage.html#exposing-happypanda-x">Exposing HappyPanda X</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../translation.html">Translations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../settings.html">Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../switches.html">Command-Line Arguments</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../env.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../client.html">Creating frontends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../plugin.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../todo.html">TODO</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../api_general.html">General</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api.html">Server API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api_plugin.html">Plugin API</a></li>
</ul>
</ul>
</li>
              
            
            
              
                
              
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>


<ul class="quick-links">
    <li>
        <strong>Quick links</strong>
    </li>
    <li class="quick-link">
        <a class="github-button" href="https://github.com/pewpews" aria-label="Follow @pewpews on GitHub">Follow @pewpews</a>
    </li>
    <li class="quick-link">
        <a class="github-button" href="https://github.com/pewpews/happypandax/issues" data-icon="octicon-issue-opened" data-show-count="true" aria-label="Issue pewpews/happypandax on GitHub">Issue</a>
    </li>
    <li class="divider">&middot;</li>
    <li class="quick-link">
        <a class="github-button" href="https://github.com/pewpews/happypandax" data-icon="octicon-star" data-show-count="true" aria-label="Star pewpews/happypandax on GitHub">Star</a>
    </li>
    <li class="quick-link">
        <a class="github-button" href="https://github.com/pewpews/happypandax/fork" data-icon="octicon-repo-forked" data-show-count="true" aria-label="Fork pewpews/happypandax on GitHub">Fork</a>
    </li>
    <li class="divider">&middot;</li>
    <li class="quick-link">
        <a href="https://twitter.com/pewspew"
           class="twitter-follow-button" data-width="145px"
           data-link-color="#0069D6" data-show-count="false">
            Follow
            @pewspew
        </a>
    </li>
    <li class="quick-link">
        <a href="https://twitter.com/share" class="twitter-share-button"
           data-url="" data-count="horizontal"
           data-via="twbootstrap"
           data-related="pewpews:Creator of HappyPanda X">Tweet</a>
    </li>
</ul>
<div class="container">
    <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary">
        </div>
      </div>
        <div class="col-md-9 content">
            
  <h1>Source code for happypanda.core.commands.io_cmd</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">send2trash</span>
<span class="kn">import</span> <span class="nn">attr</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">imghdr</span>
<span class="kn">import</span> <span class="nn">errno</span>

<span class="kn">from</span> <span class="nn">io</span> <span class="k">import</span> <span class="n">BytesIO</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="k">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">zipfile</span> <span class="k">import</span> <span class="n">ZipFile</span>
<span class="kn">from</span> <span class="nn">rarfile</span> <span class="k">import</span> <span class="n">RarFile</span>
<span class="kn">from</span> <span class="nn">tarfile</span> <span class="k">import</span> <span class="n">TarFile</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="k">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">gevent</span> <span class="k">import</span> <span class="n">fileobject</span>

<span class="kn">from</span> <span class="nn">happypanda.common</span> <span class="k">import</span> <span class="n">hlogger</span><span class="p">,</span> <span class="n">exceptions</span><span class="p">,</span> <span class="n">utils</span><span class="p">,</span> <span class="n">constants</span>
<span class="kn">from</span> <span class="nn">happypanda.core.command</span> <span class="k">import</span> <span class="n">CoreCommand</span><span class="p">,</span> <span class="n">CommandEntry</span><span class="p">,</span> <span class="n">AsyncCommand</span><span class="p">,</span> <span class="n">Command</span>
<span class="kn">from</span> <span class="nn">happypanda.core.services</span> <span class="k">import</span> <span class="n">ImageService</span>
<span class="kn">from</span> <span class="nn">happypanda.core</span> <span class="k">import</span> <span class="n">db</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">hlogger</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">log_ns_command</span> <span class="o">+</span> <span class="vm">__name__</span><span class="p">)</span>


<span class="nd">@attr</span><span class="o">.</span><span class="n">s</span>
<span class="k">class</span> <span class="nc">ImageProperties</span><span class="p">:</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">ImageSize</span><span class="p">(</span><span class="o">*</span><span class="n">constants</span><span class="o">.</span><span class="n">image_sizes</span><span class="p">[</span><span class="s1">&#39;medium&#39;</span><span class="p">]))</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">output_path</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">create_symlink</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<div class="viewcode-block" id="ImageItem"><a class="viewcode-back" href="../../../../api_plugin.html#happypanda.core.commands.io_cmd.ImageItem">[docs]</a><span class="k">class</span> <span class="nc">ImageItem</span><span class="p">(</span><span class="n">AsyncCommand</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Returns:</span>
<span class="sd">        a path to generated image</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath_or_bytes</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">service</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">ImageService</span><span class="p">)</span> <span class="ow">or</span> <span class="n">service</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="n">ImageProperties</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">service</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">service</span> <span class="o">=</span> <span class="n">ImageService</span><span class="o">.</span><span class="n">generic</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="n">constants</span><span class="o">.</span><span class="n">Priority</span><span class="o">.</span><span class="n">Low</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_image</span> <span class="o">=</span> <span class="n">filepath_or_bytes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_retrying</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span>

    <span class="nd">@properties</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_properties</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span> <span class="o">=</span> <span class="n">x</span>

    <span class="k">def</span> <span class="nf">_check_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">props</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">props</span><span class="p">,</span> <span class="n">ImageProperties</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">props</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">props</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">ImageSize</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">props</span><span class="o">.</span><span class="n">radius</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">props</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">props</span><span class="o">.</span><span class="n">output_dir</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">props</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">props</span><span class="o">.</span><span class="n">output_path</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">props</span><span class="o">.</span><span class="n">output_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">props</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">props</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_convert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">colormode</span><span class="o">=</span><span class="s2">&quot;RGB&quot;</span><span class="p">,</span> <span class="n">img_ext</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">colormode</span> <span class="o">==</span> <span class="s2">&quot;RGB&quot;</span> <span class="ow">or</span> <span class="n">colormode</span> <span class="o">==</span> <span class="s2">&quot;RGBA&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">im</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;RGBA&#39;</span> <span class="ow">and</span> <span class="n">img_ext</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;.jepg&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpg&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">im</span>
            <span class="k">if</span> <span class="n">im</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;LA&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">im</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;RGBA&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">im</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">colormode</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">colormode</span> <span class="o">==</span> <span class="s2">&quot;GRAY&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">im</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;L&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">im</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">colormode</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_native</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_generate</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_generate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">d</span><span class="p">(</span><span class="s2">&quot;Generating image thumbnail&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">,</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_max_progress</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_progress</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">size</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">fs</span> <span class="o">=</span> <span class="n">CoreFS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fs</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">d</span><span class="p">(</span><span class="s2">&quot;Image file does not exists&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="s2">&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_image</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">im</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">image_path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrying</span><span class="p">:</span>
                    <span class="n">ext</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">imghdr</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ext</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">imghdr</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">)</span>

            <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">)</span>
            <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">img_ext</span><span class="o">=</span><span class="n">ext</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">output_path</span><span class="p">:</span>
                <span class="n">image_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">output_path</span>
                <span class="n">_f</span><span class="p">,</span> <span class="n">_ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">_ext</span><span class="p">:</span>
                    <span class="n">image_path</span> <span class="o">=</span> <span class="n">_f</span> <span class="o">+</span> <span class="n">ext</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">output_dir</span><span class="p">:</span>
                <span class="n">o_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">output_dir</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">o_dir</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">o_dir</span><span class="p">)</span>
                <span class="n">o_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">name</span> <span class="k">else</span> <span class="n">utils</span><span class="o">.</span><span class="n">random_name</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">o_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">ext</span><span class="p">):</span>
                    <span class="n">o_name</span> <span class="o">=</span> <span class="n">o_name</span> <span class="o">+</span> <span class="n">ext</span>
                <span class="n">image_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">o_dir</span><span class="p">,</span> <span class="n">o_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">image_path</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>

            <span class="n">save_image</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">size</span><span class="o">.</span><span class="n">width</span> <span class="ow">and</span> <span class="n">size</span><span class="o">.</span><span class="n">height</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ext</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.gif&quot;</span><span class="p">):</span>
                    <span class="n">new_frame</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;RGBA&#39;</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                    <span class="n">new_frame</span><span class="o">.</span><span class="n">paste</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">im</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;RGBA&#39;</span><span class="p">))</span>
                    <span class="n">im</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">im</span> <span class="o">=</span> <span class="n">new_frame</span>
                <span class="n">im</span><span class="o">.</span><span class="n">thumbnail</span><span class="p">((</span><span class="n">size</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">size</span><span class="o">.</span><span class="n">height</span><span class="p">),</span> <span class="n">Image</span><span class="o">.</span><span class="n">ANTIALIAS</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">create_symlink</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">fs</span> <span class="ow">and</span> <span class="n">fs</span><span class="o">.</span><span class="n">inside_archive</span><span class="p">:</span>
                        <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">image_path</span> <span class="o">=</span> <span class="n">image_path</span> <span class="o">+</span> <span class="n">constants</span><span class="o">.</span><span class="n">link_ext</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">)</span>
                    <span class="n">save_image</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">save_image</span><span class="p">:</span>
                <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrying</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">w</span><span class="p">(</span><span class="s2">&quot;Failed generating image:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="s2">&quot;retrying...&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_retrying</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">im</span><span class="p">:</span>
                    <span class="n">im</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">im</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">w</span><span class="p">(</span><span class="s2">&quot;Failed generating image:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">im</span><span class="p">:</span>
                <span class="n">im</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">d</span><span class="p">(</span><span class="s2">&quot;Generated image path:&quot;</span><span class="p">,</span> <span class="n">image_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">image_path</span>

<div class="viewcode-block" id="ImageItem.gen_hash"><a class="viewcode-back" href="../../../../api_plugin.html#happypanda.core.commands.io_cmd.ImageItem.gen_hash">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">gen_hash</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a hash based on database model, image size and optionally item id</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Base</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Base</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">ImageSize</span><span class="p">)</span>

        <span class="n">hash_str</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">hash_str</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
        <span class="n">hash_str</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">item_id</span><span class="p">)</span> <span class="k">if</span> <span class="n">item_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

        <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">hash_str</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="CoreFS"><a class="viewcode-back" href="../../../../api_plugin.html#happypanda.core.commands.io_cmd.CoreFS">[docs]</a><span class="k">class</span> <span class="nc">CoreFS</span><span class="p">(</span><span class="n">CoreCommand</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Encapsulates path on the filesystem</span>

<span class="sd">    Default supported archive types are:</span>
<span class="sd">        ZIP, RAR, CBR, CBZ, TAR.GZ, TAR.BZ2 and TAR.XZ</span>

<span class="sd">    Default supported image types are:</span>
<span class="sd">        JPG/JPEG, BMP, PNG and GIF</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ZIP</span> <span class="o">=</span> <span class="s1">&#39;.zip&#39;</span>
    <span class="n">RAR</span> <span class="o">=</span> <span class="s1">&#39;.rar&#39;</span>
    <span class="n">CBR</span> <span class="o">=</span> <span class="s1">&#39;.cbr&#39;</span>
    <span class="n">CBZ</span> <span class="o">=</span> <span class="s1">&#39;.cbz&#39;</span>
    <span class="n">TARGZ</span> <span class="o">=</span> <span class="s1">&#39;.tar.gz&#39;</span>
    <span class="n">TARBZ2</span> <span class="o">=</span> <span class="s1">&#39;.tar.bz2&#39;</span>
    <span class="n">TARXZ</span> <span class="o">=</span> <span class="s1">&#39;.tar.xz&#39;</span>

    <span class="n">JPG</span> <span class="o">=</span> <span class="s1">&#39;.jpg&#39;</span>
    <span class="n">JPEG</span> <span class="o">=</span> <span class="s1">&#39;.jpeg&#39;</span>
    <span class="n">BMP</span> <span class="o">=</span> <span class="s1">&#39;.bmp&#39;</span>
    <span class="n">PNG</span> <span class="o">=</span> <span class="s1">&#39;.png&#39;</span>
    <span class="n">GIF</span> <span class="o">=</span> <span class="s1">&#39;.gif&#39;</span>

    <span class="n">_archive_formats</span> <span class="o">=</span> <span class="n">CommandEntry</span><span class="p">(</span><span class="s2">&quot;archive_formats&quot;</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
    <span class="n">_image_formats</span> <span class="o">=</span> <span class="n">CommandEntry</span><span class="p">(</span><span class="s2">&quot;image_formats&quot;</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(),</span> <span class="n">archive</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="p">(</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">CoreFS</span><span class="p">))</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_o_path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filetype</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_archive</span> <span class="o">=</span> <span class="n">archive</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extacted_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="nd">@_archive_formats</span><span class="o">.</span><span class="n">default</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_archive_formats_def</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">CoreFS</span><span class="o">.</span><span class="n">ZIP</span><span class="p">,</span> <span class="n">CoreFS</span><span class="o">.</span><span class="n">RAR</span><span class="p">,</span> <span class="n">CoreFS</span><span class="o">.</span><span class="n">CBR</span><span class="p">,</span> <span class="n">CoreFS</span><span class="o">.</span><span class="n">CBZ</span><span class="p">,</span> <span class="n">CoreFS</span><span class="o">.</span><span class="n">TARGZ</span><span class="p">,</span>
                <span class="n">CoreFS</span><span class="o">.</span><span class="n">TARBZ2</span><span class="p">,</span> <span class="n">CoreFS</span><span class="o">.</span><span class="n">TARXZ</span><span class="p">)</span>

    <span class="nd">@_image_formats</span><span class="o">.</span><span class="n">default</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_image_formats_def</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">CoreFS</span><span class="o">.</span><span class="n">JPG</span><span class="p">,</span> <span class="n">CoreFS</span><span class="o">.</span><span class="n">JPEG</span><span class="p">,</span> <span class="n">CoreFS</span><span class="o">.</span><span class="n">BMP</span><span class="p">,</span> <span class="n">CoreFS</span><span class="o">.</span><span class="n">PNG</span><span class="p">,</span> <span class="n">CoreFS</span><span class="o">.</span><span class="n">GIF</span><span class="p">)</span>

<div class="viewcode-block" id="CoreFS.archive_formats"><a class="viewcode-back" href="../../../../api_plugin.html#happypanda.core.commands.io_cmd.CoreFS.archive_formats">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">archive_formats</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="s2">&quot;Get supported archive formats&quot;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_get_commands</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_archive_formats</span><span class="o">.</span><span class="n">call</span><span class="p">()</span> <span class="k">as</span> <span class="n">plg</span><span class="p">:</span>
            <span class="n">formats</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">plg</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="n">formats</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">formats</span><span class="p">)</span></div>

<div class="viewcode-block" id="CoreFS.image_formats"><a class="viewcode-back" href="../../../../api_plugin.html#happypanda.core.commands.io_cmd.CoreFS.image_formats">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">image_formats</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="s2">&quot;Get supported image formats&quot;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_get_commands</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_image_formats</span><span class="o">.</span><span class="n">call</span><span class="p">()</span> <span class="k">as</span> <span class="n">plg</span><span class="p">:</span>
            <span class="n">formats</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">plg</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="n">formats</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">formats</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Get name of file or directory&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="o">.</span><span class="n">name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Get path as string&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">archive_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Get path to the archive as string&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_archive</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">inside_archive</span><span class="p">:</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="o">.</span><span class="n">parents</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">parts</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">parts</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive_formats</span><span class="p">():</span>
                    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">archive_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Get the full filename inside the archive&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inside_archive</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_archive</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_o_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_archive</span><span class="o">.</span><span class="n">path_separator</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_o_path</span><span class="p">:</span>
                <span class="n">parts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_o_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_archive</span><span class="o">.</span><span class="n">path_separator</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="o">.</span><span class="n">parts</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">parts</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">parts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">archive_formats</span><span class="p">()):</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_archive</span><span class="o">.</span><span class="n">path_separator</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Check if path is pointed to a file&quot;</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dir</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Check if path is pointed to a directory&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inside_archive</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_archive</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_archive</span><span class="o">.</span><span class="n">is_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">archive_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_archive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Check if path is pointed to an archive file&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ext</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive_formats</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">inside_archive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Check if path is pointed to an object inside an archive&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">d</span><span class="p">(</span><span class="s2">&quot;Checking if path is inside archive&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">)</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="o">.</span><span class="n">parents</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">parts</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">parts</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive_formats</span><span class="p">():</span>
                <span class="n">log</span><span class="o">.</span><span class="n">d</span><span class="p">(</span><span class="s2">&quot;Path is inside an archive&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="n">log</span><span class="o">.</span><span class="n">d</span><span class="p">(</span><span class="s2">&quot;Path is not inside an archive&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Check if path is pointed to an image file&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_file</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ext</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_formats</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">exists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Check if path exists&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inside_archive</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_init_archive</span><span class="p">()</span>
                <span class="n">log</span><span class="o">.</span><span class="n">d</span><span class="p">(</span><span class="s2">&quot;Checking for archive path&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive_name</span><span class="p">,</span> <span class="s2">&quot;in archive&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_archive</span><span class="o">.</span><span class="n">namelist</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENXIO</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">raise</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Get file extension. An empty string is returned if path is a directory&quot;</span>
        <span class="n">suffixes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="o">.</span><span class="n">suffixes</span>
        <span class="k">while</span> <span class="n">suffixes</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">suffixes</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive_formats</span><span class="p">():</span>
                <span class="k">break</span>
            <span class="n">suffixes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="o">.</span><span class="n">suffix</span>

        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Get the amount of files and folders inside this path. 0 is returned if path is a file&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

<div class="viewcode-block" id="CoreFS.contents"><a class="viewcode-back" href="../../../../api_plugin.html#happypanda.core.commands.io_cmd.CoreFS.contents">[docs]</a>    <span class="k">def</span> <span class="nf">contents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">corefs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="s2">&quot;If this is an archive or folder, return a tuple of CoreFS objects else return None&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_archive</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_archive</span><span class="p">()</span>
            <span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_archive</span><span class="o">.</span><span class="n">path_separator</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="o">.</span><span class="n">parts</span><span class="p">)</span>
            <span class="n">l</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_archive</span><span class="o">.</span><span class="n">path_separator</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">root</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_archive</span><span class="o">.</span><span class="n">namelist</span><span class="p">())</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dir</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inside_archive</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">l</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="o">.</span><span class="n">iterdir</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">corefs</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">CoreFS</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">l</span></div>

<div class="viewcode-block" id="CoreFS.get"><a class="viewcode-back" href="../../../../api_plugin.html#happypanda.core.commands.io_cmd.CoreFS.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="s2">&quot;Get path as string. If path is inside an archive it will get extracted&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inside_archive</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_archive</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extacted_file</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_extacted_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extacted_file</span><span class="o">.</span><span class="n">path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span></div>

<div class="viewcode-block" id="CoreFS.delete"><a class="viewcode-back" href="../../../../api_plugin.html#happypanda.core.commands.io_cmd.CoreFS.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">send_to_trash</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="s2">&quot;Delete path&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_archive</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">inside_archive</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">send_to_trash</span><span class="p">:</span>
                <span class="n">send2trash</span><span class="o">.</span><span class="n">send2trash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ignore_errors</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error raised while trying to delete:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span></div>

    <span class="nd">@contextmanager</span>  <span class="c1"># TODO: Make usable without contextmanager too</span>
    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="s2">&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inside_archive</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_init_archive</span><span class="p">()</span>
                <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_archive</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">archive_name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">fileobject</span><span class="o">.</span><span class="n">FileObjectThread</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">PermissionError</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dir</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">CoreError</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">this_function</span><span class="p">(),</span> <span class="s2">&quot;Tried to open a folder which is not possible&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">yield</span> <span class="n">f</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="CoreFS.open_with_default"><a class="viewcode-back" href="../../../../api_plugin.html#happypanda.core.commands.io_cmd.CoreFS.open_with_default">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">open_with_default</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="s2">&quot;Open path with the default application&quot;</span>
        <span class="k">if</span> <span class="n">constants</span><span class="o">.</span><span class="n">is_osx</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">((</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">constants</span><span class="o">.</span><span class="n">is_win</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">startfile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">constants</span><span class="o">.</span><span class="n">is_linux</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">((</span><span class="s1">&#39;xdg-open&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_archive</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_archive</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="CoreFS.extract"><a class="viewcode-back" href="../../../../api_plugin.html#happypanda.core.commands.io_cmd.CoreFS.extract">[docs]</a>    <span class="k">def</span> <span class="nf">extract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract files if path is an archive</span>

<span class="sd">        Args:</span>
<span class="sd">            filename: a string or a tuple of strings of contents inside the archive, leave None to extract all contents</span>
<span class="sd">            target: a path to where contents will be extracted to, leave None to use a temp directory</span>

<span class="sd">        Returns:</span>
<span class="sd">            a CoreFS object pointed to the extracted files</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="n">target</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_archive</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="p">(</span><span class="n">filename</span><span class="p">,)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_archive</span><span class="p">:</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">target</span><span class="p">:</span>
                <span class="n">target</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">create_temp_dir</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CoreFS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_archive</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">target</span><span class="p">)))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">CoreFS</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inside_archive</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">CoreFS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_archive</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">archive_name</span><span class="p">,</span> <span class="n">target</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_archive</span><span class="o">.</span><span class="n">extract_all</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">CoreFS</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NotAnArchiveError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_resolve_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">CoreFS</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">_path</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_o_path</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">_o_path</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_archive</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">_archive</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_filetype</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">_filetype</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="n">p</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_archive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_archive</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inside_archive</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_archive</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_archive</span> <span class="o">=</span> <span class="n">Archive</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">archive_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">CoreFS</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">path</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__lt__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;CoreFS(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;CoreFS(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span></div>


<div class="viewcode-block" id="Archive"><a class="viewcode-back" href="../../../../api_plugin.html#happypanda.core.commands.io_cmd.Archive">[docs]</a><span class="k">class</span> <span class="nc">Archive</span><span class="p">(</span><span class="n">CoreCommand</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Work with archive files</span>

<span class="sd">    Args:</span>
<span class="sd">        fpath: path to archive file</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_init</span> <span class="o">=</span> <span class="n">CommandEntry</span><span class="p">(</span><span class="s1">&#39;init&#39;</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">)</span>
    <span class="n">_path_sep</span> <span class="o">=</span> <span class="n">CommandEntry</span><span class="p">(</span><span class="s1">&#39;path_sep&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">)</span>
    <span class="n">_test_corrupt</span> <span class="o">=</span> <span class="n">CommandEntry</span><span class="p">(</span><span class="s1">&#39;test_corrupt&#39;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">object</span><span class="p">)</span>
    <span class="n">_is_dir</span> <span class="o">=</span> <span class="n">CommandEntry</span><span class="p">(</span><span class="s1">&#39;is_dir&#39;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
    <span class="n">_extract</span> <span class="o">=</span> <span class="n">CommandEntry</span><span class="p">(</span><span class="s2">&quot;extract&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">)</span>
    <span class="n">_extract_all</span> <span class="o">=</span> <span class="n">CommandEntry</span><span class="p">(</span><span class="s2">&quot;extract_all&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">)</span>
    <span class="n">_namelist</span> <span class="o">=</span> <span class="n">CommandEntry</span><span class="p">(</span><span class="s2">&quot;namelist&quot;</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">object</span><span class="p">)</span>
    <span class="n">_open</span> <span class="o">=</span> <span class="n">CommandEntry</span><span class="p">(</span><span class="s2">&quot;open&quot;</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
    <span class="n">_close</span> <span class="o">=</span> <span class="n">CommandEntry</span><span class="p">(</span><span class="s2">&quot;close&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">object</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_def_formats</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">CoreFS</span><span class="o">.</span><span class="n">ZIP</span><span class="p">,</span> <span class="n">CoreFS</span><span class="o">.</span><span class="n">RAR</span><span class="p">,</span> <span class="n">CoreFS</span><span class="o">.</span><span class="n">CBZ</span><span class="p">,</span> <span class="n">CoreFS</span><span class="o">.</span><span class="n">CBR</span><span class="p">,</span> <span class="n">CoreFS</span><span class="o">.</span><span class="n">TARBZ2</span><span class="p">,</span>
                <span class="n">CoreFS</span><span class="o">.</span><span class="n">TARGZ</span><span class="p">,</span> <span class="n">CoreFS</span><span class="o">.</span><span class="n">TARXZ</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fpath</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_opened</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_archive</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pathfs</span> <span class="o">=</span> <span class="n">CoreFS</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pathfs</span><span class="o">.</span><span class="n">ext</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ArchiveExistError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pathfs</span><span class="o">.</span><span class="n">ext</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">CoreFS</span><span class="o">.</span><span class="n">archive_formats</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ArchiveUnsupportedError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init</span><span class="o">.</span><span class="n">call_capture</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ext</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">plg</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_archive</span> <span class="o">=</span> <span class="n">plg</span><span class="o">.</span><span class="n">first_or_none</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_archive</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">CoreError</span><span class="p">(</span>
                    <span class="n">utils</span><span class="o">.</span><span class="n">this_function</span><span class="p">(),</span>
                    <span class="s2">&quot;No valid archive handler found for this archive type: &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_ext</span><span class="p">))</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path_sep</span><span class="o">.</span><span class="n">call_capture</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ext</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_archive</span><span class="p">)</span> <span class="k">as</span> <span class="n">plg</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">plg</span><span class="o">.</span><span class="n">first_or_none</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">path_separator</span> <span class="o">=</span> <span class="n">p</span> <span class="k">if</span> <span class="n">p</span> <span class="k">else</span> <span class="s1">&#39;/&#39;</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_archive</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_archive&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_archive</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="nd">@_test_corrupt</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">capture</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_test_corrupt_def</span><span class="p">(</span><span class="n">archive</span><span class="p">,</span> <span class="n">capture</span><span class="o">=</span><span class="n">_def_formats</span><span class="p">()):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">archive</span><span class="p">,</span> <span class="n">ZipFile</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">archive</span><span class="o">.</span><span class="n">testzip</span><span class="p">())</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">archive</span><span class="p">,</span> <span class="n">RarFile</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">archive</span><span class="o">.</span><span class="n">testrar</span><span class="p">())</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">archive</span><span class="p">,</span> <span class="n">TarFile</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@_init</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">capture</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_init_def</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">capture</span><span class="o">=</span><span class="n">_def_formats</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;.zip&#39;</span><span class="p">,</span> <span class="s1">&#39;.cbz&#39;</span><span class="p">):</span>
            <span class="n">o</span> <span class="o">=</span> <span class="n">ZipFile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">path</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;.rar&#39;</span><span class="p">,</span> <span class="s1">&#39;.cbr&#39;</span><span class="p">):</span>
            <span class="n">o</span> <span class="o">=</span> <span class="n">RarFile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">CoreFS</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">ext</span> <span class="ow">in</span> <span class="p">(</span><span class="n">CoreFS</span><span class="o">.</span><span class="n">TARBZ2</span><span class="p">,</span> <span class="n">CoreFS</span><span class="o">.</span><span class="n">TARGZ</span><span class="p">,</span> <span class="n">CoreFS</span><span class="o">.</span><span class="n">TARXZ</span><span class="p">):</span>
            <span class="n">o</span> <span class="o">=</span> <span class="n">TarFile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="n">o</span><span class="o">.</span><span class="n">hpx_path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="k">return</span> <span class="n">o</span>

    <span class="nd">@_namelist</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">capture</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_namelist_def</span><span class="p">(</span><span class="n">archive</span><span class="p">,</span> <span class="n">capture</span><span class="o">=</span><span class="n">_def_formats</span><span class="p">()):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">archive</span><span class="p">,</span> <span class="n">TarFile</span><span class="p">):</span>
            <span class="n">filelist</span> <span class="o">=</span> <span class="n">archive</span><span class="o">.</span><span class="n">getnames</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filelist</span> <span class="o">=</span> <span class="n">archive</span><span class="o">.</span><span class="n">namelist</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">filelist</span>

    <span class="nd">@_is_dir</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">capture</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_is_dir_def</span><span class="p">(</span><span class="n">archive</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">capture</span><span class="o">=</span><span class="n">_def_formats</span><span class="p">()):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Archive</span><span class="o">.</span><span class="n">_namelist_def</span><span class="p">(</span><span class="n">archive</span><span class="p">)</span> <span class="ow">and</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Archive</span><span class="o">.</span><span class="n">_namelist_def</span><span class="p">(</span><span class="n">archive</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ArchiveFileNotFoundError</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">archive</span><span class="o">.</span><span class="n">hpx_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">archive</span><span class="p">,</span> <span class="n">ZipFile</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">archive</span><span class="p">,</span> <span class="n">RarFile</span><span class="p">):</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">archive</span><span class="o">.</span><span class="n">getinfo</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">info</span><span class="o">.</span><span class="n">isdir</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">archive</span><span class="p">,</span> <span class="n">TarFile</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">info</span> <span class="o">=</span> <span class="n">archive</span><span class="o">.</span><span class="n">getmember</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">info</span><span class="o">.</span><span class="n">isdir</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ArchiveFileNotFoundError</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">archive</span><span class="o">.</span><span class="n">hpx_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@_extract</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">capture</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_extract_def</span><span class="p">(</span><span class="n">archive</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">capture</span><span class="o">=</span><span class="n">_def_formats</span><span class="p">()):</span>
        <span class="n">temp_p</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">archive</span><span class="p">,</span> <span class="n">ZipFile</span><span class="p">):</span>
            <span class="n">membs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">Archive</span><span class="o">.</span><span class="n">_namelist_def</span><span class="p">(</span><span class="n">archive</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span> <span class="o">!=</span> <span class="n">filename</span><span class="p">:</span>
                    <span class="n">membs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">temp_p</span> <span class="o">=</span> <span class="n">archive</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">membs</span><span class="p">:</span>
                <span class="n">archive</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">archive</span><span class="p">,</span> <span class="n">RarFile</span><span class="p">):</span>
            <span class="n">temp_p</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
            <span class="n">archive</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">archive</span><span class="p">,</span> <span class="n">TarFile</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">info</span> <span class="o">=</span> <span class="n">archive</span><span class="o">.</span><span class="n">getmember</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="n">archive</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="p">[</span><span class="n">info</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ArchiveFileNotFoundError</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">archive</span><span class="o">.</span><span class="n">hpx_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">temp_p</span>

    <span class="nd">@_extract_all</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">capture</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_extract_all_def</span><span class="p">(</span><span class="n">archive</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">capture</span><span class="o">=</span><span class="n">_def_formats</span><span class="p">()):</span>
        <span class="n">target_p</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">archive</span><span class="p">,</span> <span class="p">(</span><span class="n">ZipFile</span><span class="p">,</span> <span class="n">RarFile</span><span class="p">,</span> <span class="n">TarFile</span><span class="p">)):</span>
            <span class="n">archive</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">target_p</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">target_p</span>

    <span class="nd">@_open</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">capture</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_open_def</span><span class="p">(</span><span class="n">archive</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">capture</span><span class="o">=</span><span class="n">_def_formats</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Archive</span><span class="o">.</span><span class="n">_namelist_def</span><span class="p">(</span><span class="n">archive</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ArchiveFileNotFoundError</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">archive</span><span class="o">.</span><span class="n">hpx_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">archive</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@_close</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">capture</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_close_def</span><span class="p">(</span><span class="n">archive</span><span class="p">,</span> <span class="n">capture</span><span class="o">=</span><span class="n">_def_formats</span><span class="p">()):</span>
        <span class="n">archive</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_corrupt</span><span class="o">.</span><span class="n">call_capture</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ext</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_archive</span><span class="p">)</span> <span class="k">as</span> <span class="n">plg</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">plg</span><span class="o">.</span><span class="n">first_or_none</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">r</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ArchiveCorruptError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_normalize_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_separator</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_separator</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span>

    <span class="k">def</span> <span class="nf">namelist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_namelist</span><span class="o">.</span><span class="n">call_capture</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ext</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_archive</span><span class="p">)</span> <span class="k">as</span> <span class="n">plg</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">plg</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

<div class="viewcode-block" id="Archive.is_dir"><a class="viewcode-back" href="../../../../api_plugin.html#happypanda.core.commands.io_cmd.Archive.is_dir">[docs]</a>    <span class="k">def</span> <span class="nf">is_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if the provided name in the archive is a directory or not</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_filename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_dir</span><span class="o">.</span><span class="n">call_capture</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ext</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_archive</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">plg</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">plg</span><span class="o">.</span><span class="n">first</span><span class="p">()</span></div>

<div class="viewcode-block" id="Archive.extract"><a class="viewcode-back" href="../../../../api_plugin.html#happypanda.core.commands.io_cmd.Archive.extract">[docs]</a>    <span class="k">def</span> <span class="nf">extract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts file from archive to target path</span>
<span class="sd">        Returns path to the extracted file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_filename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ArchiveExtractError</span><span class="p">(</span><span class="s2">&quot;Target path does not exist: &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)))</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract</span><span class="o">.</span><span class="n">call_capture</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ext</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_archive</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="k">as</span> <span class="n">plg</span><span class="p">:</span>
            <span class="n">extract_path</span> <span class="o">=</span> <span class="n">plg</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">extract_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="Archive.extract_all"><a class="viewcode-back" href="../../../../api_plugin.html#happypanda.core.commands.io_cmd.Archive.extract_all">[docs]</a>    <span class="k">def</span> <span class="nf">extract_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts all files to given path, and returns path</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ArchiveExtractError</span><span class="p">(</span><span class="s2">&quot;Target path does not exist: &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)))</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_all</span><span class="o">.</span><span class="n">call_capture</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ext</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_archive</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="k">as</span> <span class="n">plg</span><span class="p">:</span>
            <span class="n">extract_path</span> <span class="o">=</span> <span class="n">plg</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">extract_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="Archive.open"><a class="viewcode-back" href="../../../../api_plugin.html#happypanda.core.commands.io_cmd.Archive.open">[docs]</a>    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open file in archive, returns a file-like object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_filename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open</span><span class="o">.</span><span class="n">call_capture</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ext</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_archive</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span> <span class="k">as</span> <span class="n">plg</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">plg</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s1">&#39;write&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">PluginHandlerError</span><span class="p">(</span><span class="n">plg</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;Expected a file-like object from archive.open&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">r</span></div>

<div class="viewcode-block" id="Archive.close"><a class="viewcode-back" href="../../../../api_plugin.html#happypanda.core.commands.io_cmd.Archive.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Close archive, releases all open resources</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_close</span><span class="o">.</span><span class="n">call_capture</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ext</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_archive</span><span class="p">)</span> <span class="k">as</span> <span class="n">plg</span><span class="p">:</span>
            <span class="n">plg</span><span class="o">.</span><span class="n">first</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="GalleryFS"><a class="viewcode-back" href="../../../../api_plugin.html#happypanda.core.commands.io_cmd.GalleryFS">[docs]</a><span class="k">class</span> <span class="nc">GalleryFS</span><span class="p">(</span><span class="n">CoreCommand</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Encapsulates an gallery object on the filesystem</span>
<span class="sd">    Args:</span>
<span class="sd">        path: a valid path to a valid gallery archive/folder</span>
<span class="sd">        db_gallery: Database Gallery object</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_or_dbobject</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path_or_dbobject</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">CoreFS</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Gallery</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gallery</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">artists</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">language</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convention</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># number : CoreFS</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path_or_dbobject</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Gallery</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gallery</span> <span class="o">=</span> <span class="n">path_or_dbobject</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">CoreFS</span><span class="p">(</span><span class="n">path_or_dbobject</span><span class="p">)</span>

    <span class="c1"># def load(self):</span>
    <span class="c1">#    &quot;Extracts gallery data&quot;</span>
    <span class="c1">#    _, self.name = os.path.split(self.path)</span>
    <span class="c1">#    info = GalleryScan.name_parser(self.path)</span>
    <span class="c1">#    self.title = info[&#39;title&#39;]</span>
    <span class="c1">#    self.artists.append(info[&#39;artist&#39;])</span>
    <span class="c1">#    self.language = info[&#39;language&#39;]</span>
    <span class="c1">#    self.convention = info[&#39;convention&#39;]</span>
    <span class="c1">#    if self.gallery_type == utils.PathType.Directoy:</span>
    <span class="c1">#        self.pages = self._get_folder_pages()</span>
    <span class="c1">#    elif self.gallery_type == utils.PathType.Archive:</span>
    <span class="c1">#        self.pages = self._get_archive_pages()</span>
    <span class="c1">#    else:</span>
    <span class="c1">#        assert False, &quot;this shouldnt happen... ({})&quot;.format(self.path)</span>

<div class="viewcode-block" id="GalleryFS.get_gallery"><a class="viewcode-back" href="../../../../api_plugin.html#happypanda.core.commands.io_cmd.GalleryFS.get_gallery">[docs]</a>    <span class="k">def</span> <span class="nf">get_gallery</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Creates/Updates database gallery&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">gallery</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gallery</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Gallery</span><span class="p">()</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Title</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
        <span class="c1"># TODO: add language to title</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gallery</span><span class="o">.</span><span class="n">titles</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">x</span>
                <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gallery</span><span class="o">.</span><span class="n">titles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gallery</span><span class="o">.</span><span class="n">artists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">db</span><span class="o">.</span><span class="n">Artist</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">artists</span><span class="p">]</span>
        <span class="n">db_pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gallery</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">db_pages</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">db_pages</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gallery</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gallery</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">db</span><span class="o">.</span><span class="n">Page</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">number</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">gallery</span></div>

    <span class="k">def</span> <span class="nf">_get_folder_pages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;&quot;</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dir_images</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">x</span><span class="o">.</span><span class="n">path</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">scandir</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span>
                <span class="n">CoreFS</span><span class="o">.</span><span class="n">image_formats</span><span class="p">())]</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">dir_images</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">pages</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">pages</span>

    <span class="k">def</span> <span class="nf">_get_archive_pages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<div class="viewcode-block" id="NameParser"><a class="viewcode-back" href="../../../../api_plugin.html#happypanda.core.commands.io_cmd.NameParser">[docs]</a><span class="k">class</span> <span class="nc">NameParser</span><span class="p">(</span><span class="n">Command</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">parse</span> <span class="o">=</span> <span class="n">CommandEntry</span><span class="p">(</span><span class="s2">&quot;rename&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parsed</span> <span class="o">=</span> <span class="p">{}</span></div>
</pre></div>

        </div>
          
    </div>
</div>

<script async defer src="https://buttons.github.io/buttons.js"></script>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
      
    </p>
    <p>
        &copy; Copyright Twiddly.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.2.<br/>
    </p>
  </div>
</footer>
  </body>
</html>